# Інструкція з інтеграції Lootbox iFrame Widget

## Загальний опис

Цей документ містить всю необхідну інформацію для інтеграції віджета лутбокса через iframe замість Vue-компонента `LootBoxSpinWheel.vue`.

**Основна зміна:** Замість передачі props та обробки emit-подій використовуються query-параметри в URL та PostMessage API для комунікації.

---

## 📋 Query-параметри для URL iframe

### Обов'язкові параметри

#### `style`
- **Тип:** String
- **Опис:** Назва теми візуального оформлення
- **Доступні значення:** 
  - `RocketWheelLite` - легка тема (за замовчуванням)
  - `RocketWheelPro` - преміум тема
- **Приклад:** `?style=RocketWheelPro`

#### `sectors`
- **Тип:** String (comma-separated)
- **Опис:** Список призів для секторів колеса
- **Формат:** Текстові значення через кому з пробілом: `"500 USD, 5000 USD, 10 FS, ..."`
- **Кількість:** Рекомендовано 8 секторів (повинна відповідати кількості `sectors_type`)
- **URL encoding:** Пробіли та спецсимволи повинні бути закодовані (`%20` для пробілів)
- **Декодований приклад:** `500 USD, 5000 USD, 10 FS, 20 FS, 35 FS, 25 USD, 100 USD, 250 USD`

#### `sectors_type`
- **Тип:** String (comma-separated)
- **Опис:** Типи призів для кожного сектора
- **Формат:** Текстові значення через кому з пробілом
- **Кількість:** Має відповідати кількості `sectors`
- **Типові значення:** 
  - `Bonus Prize` - бонусні призи
  - `Free Spins` - безкоштовні спіни
  - `Cash Prize` - готівкові призи
  - Або будь-які кастомні назви
- **Декодований приклад:** `Bonus Prize, Bonus Prize, Free Spins, Free Spins, Free Spins, Bonus Prize, Bonus Prize, Bonus Prize`

### Опціональні параметри

#### `active`
- **Тип:** Boolean
- **За замовчуванням:** `true`
- **Опис:** Визначає чи активний лутбокс
- **Використання:** Встановіть `false` для тимчасового відключення взаємодії
- **Приклад:** `?active=false`

#### `fps`
- **Тип:** Boolean
- **За замовчуванням:** `false`
- **Опис:** Показує FPS-монітор для діагностики продуктивності
- **Використання:** Увімкніть для debug режиму
- **Приклад:** `?fps=true`

#### `vip_level`
- **Тип:** Number (integer >= 0)
- **За замовчуванням:** `0`
- **Опис:** VIP рівень гравця
- **Приклад:** `?vip_level=5`
- **⚠️ Важливо:** Параметр **зарезервований для майбутнього**. Наразі не впливає на відображення колеса, але в майбутніх версіях може використовуватись для кастомізації дизайну.

### Приклади повних URL

```
# Базова конфігурація
https://lootbox.example.com/?style=RocketWheelLite&sectors=100%20USD,200%20USD&sectors_type=Bonus%20Prize,Bonus%20Prize

# З VIP рівнем та FPS
https://lootbox.example.com/?style=RocketWheelPro&sectors=500%20USD,1000%20USD,50%20FS&sectors_type=Bonus%20Prize,Bonus%20Prize,Free%20Spins&vip_level=3&fps=true
```

---

## 📨 PostMessage API - Протокол комунікації

### Архітектура

```
┌─────────────────┐                    ┌──────────────────┐
│  Parent Window  │                    │  Lootbox iFrame  │
├─────────────────┤                    ├──────────────────┤
│                 │ <── lootboxReady ──│  [ініціалізація] │
│                 │                    │                  │
│                 │  ──── startSpin ──>│  [обертання 3с]  │
│                 │                    │                  │
│ [запит бекенду] │                    │                  │
│                 │                    │                  │
│                 │  ─── winSector ───>│  [зупинка 14с]   │
│                 │                    │  [анімація ~7с]  │
│                 │                    │                  │
│                 │ <──── spinEnd ─────│  [завершення]    │
└─────────────────┘                    └──────────────────┘
```

---

## 📤 Повідомлення від лутбокса (Outgoing)

### 1. `lootboxReady`

**Коли надсилається:** Відразу після повного завантаження віджета та готовності до роботи.

**Формат:**
```javascript
{
  type: 'lootboxReady'
}
```

**Що потрібно зробити:**
- Зберегти стан готовності віджета
- Розблокувати UI (кнопку "Спін")
- Можна починати відправляти команди до лутбокса

---

### 2. `spinEnd`

**Коли надсилається:** Після завершення анімації обертання та відображення виграшу (~7 секунд після встановлення виграшного сектора).

**Формат:**
```javascript
{
  type: 'spinEnd',
  data: {
    prize: '500 USD',        // Текст призу з виграшного сектора
    timestamp: 1697539200000 // Unix timestamp (milliseconds)
  }
}
```

**Що потрібно зробити:**
- Обробити результат (нарахувати приз, оновити баланс)
- Показати повідомлення користувачу про виграш
- Залогувати результат (аналітика, бекенд)
- Скинути стан для наступної гри

---

## 📥 Повідомлення до лутбокса (Incoming)

### 1. `startSpin`

**Коли відправляти:** Коли користувач ініціює обертання (натискає кнопку "Спін").

**Формат:**
```javascript
{
  type: 'startSpin'
}
```

**Що відбувається:**
- Колесо починає обертатися зі сталою швидкістю
- Анімація триває **3 секунди** у режимі очікування
- Якщо протягом цього часу не отримано `winSector`, колесо продовжує обертатися

**Важливо:**
- Відправляйте **тільки після** отримання `lootboxReady`
- Після відправки відразу робіть запит на бекенд для отримання виграшного сектора

---

### 2. `winSector`

**Коли відправляти:** Після отримання виграшного сектора з бекенда (зазвичай через 500-2000мс після `startSpin`).

**Формат:**
```javascript
{
  type: 'winSector',
  data: 5  // Номер виграшного сектора (Number)
}
```

**Нумерація секторів:**
- Сектори нумеруються від `0` до `N-1` (де N - кількість секторів)
- Для 8-секторного колеса: `0, 1, 2, 3, 4, 5, 6, 7`
- Відлік **за годинниковою стрілкою**, починаючи з верхнього сектора (під стрілкою)
- Індекс відповідає позиції в масивах `sectors` та `sectors_type`

**Візуалізація нумерації:**
```
        [0] ← Стрілка (pointer)
    [7]     [1]
  
[6]           [2]

    [5]     [3]
        [4]
```

**Що відбувається:**
- Колесо починає плавно гальмувати
- Загальна тривалість анімації від `startSpin`: **14 секунд**
- Колесо зупиняється точно на вказаному секторі
- Показується анімація виграшу (~7 секунд)
- Відправляється `spinEnd` з результатом

**Важливо:**
- `winSector` має бути відправлений **після** `startSpin`
- Індекс повинен бути валідним (0 до N-1)
- Невалідний індекс може призвести до помилок анімації

---

## 🔄 Життєвий цикл гри

### Послідовність подій

1. **Завантаження:** Створення iframe з URL та query-параметрами
2. **Ініціалізація:** Лутбокс завантажує ресурси → відправляє `lootboxReady`
3. **Готовність:** Parent отримує `lootboxReady` → розблоковує UI
4. **Запуск:** Користувач натискає "Спін" → Parent відправляє `startSpin`
5. **Обертання:** Колесо обертається (3 сек у режимі очікування)
6. **Запит:** Parent робить запит на бекенд для визначення виграшу
7. **Відповідь:** Бекенд повертає номер виграшного сектора
8. **Зупинка:** Parent відправляє `winSector` → колесо гальмує (14 сек загалом)
9. **Виграш:** Показується анімація виграшу (~7 сек)
10. **Завершення:** Лутбокс відправляє `spinEnd` з призом
11. **Обробка:** Parent обробляє результат, нараховує приз

### Тайминги

- **Початкове обертання:** 3 секунди (до отримання `winSector`)
- **Повна анімація:** 14 секунд від `startSpin` до зупинки
- **Анімація виграшу:** ~7 секунд
- **Загальний час:** ~14-21 секунд від старту до `spinEnd`

---

## ⚠️ Критичні моменти

### 1. Порядок повідомлень

**Правильно:**
```
1. lootboxReady (від iframe)
2. startSpin (до iframe)
3. winSector (до iframe)
4. spinEnd (від iframe)
```

**Неправильно:**
- Відправка `startSpin` до отримання `lootboxReady` → гра не запуститься
- Відправка `winSector` без попереднього `startSpin` → буде проігноровано
- Повторна відправка `startSpin` під час гри → може спричинити помилки

### 2. Валідація даних

**Індекс сектора:**
- Має бути цілим числом (integer)
- Діапазон: 0 до `sectors.length - 1`
- Невалідний індекс → некоректна анімація

**Кількість секторів:**
- Масиви `sectors` та `sectors_type` повинні мати однакову довжину
- Рекомендовано: 8 секторів
- Мінімум: 2 сектори

### 3. Таймаути та помилки

**Якщо бекенд не відповідає:**
- Реалізуйте timeout (рекомендовано 5 секунд)
- Передбачте fallback сценарій (випадковий сектор або повідомлення про помилку)
- Показуйте користувачу стан завантаження

**Якщо не відправити `winSector`:**
- Колесо обертатиметься нескінченно
- Потрібен fallback механізм з таймаутом

### 4. Безпека PostMessage

**Origin verification:**
- Завжди перевіряйте `event.origin` при обробці повідомлень
- Використовуйте whitelist дозволених доменів
- Не приймайте повідомлення з недовірених джерел

### 5. URL Encoding

**Query параметри:**
- Використовуйте `URLSearchParams` для формування URL
- Пробіли кодуються як `%20`
- Коми в списках `sectors` та `sectors_type` зберігаються як є (з пробілами)

---

## 🎯 Відмінності від Vue компонента

### Props → Query Parameters

**Було (Vue компонент):**
```vue
:sections="sectionsArray"
:winnerSection="winnerIndex"
```

**Стало (iframe):**
```
?sectors=500%20USD,1000%20USD
&sectors_type=Bonus%20Prize,Bonus%20Prize
```

### Events → PostMessage

**Було (Vue компонент):**
```vue
@finishSpinWheel="handleFinish"
```

**Стало (iframe):**
```javascript
window.addEventListener('message', (event) => {
  if (event.data.type === 'spinEnd') {
    // Обробка завершення
  }
});
```

### Methods → PostMessage Commands

**Було (Vue компонент):**
```javascript
this.$refs.lootbox.runWheel()
```

**Стало (iframe):**
```javascript
iframe.contentWindow.postMessage({ type: 'startSpin' }, '*')
```

### Передача виграшу

**Було (Vue компонент):**
- Prop `winnerSection` встановлювався до або після запуску
- Можна було змінити в будь-який момент

**Стало (iframe):**
- `winSector` відправляється тільки після `startSpin`
- Відправляється один раз за гру
- Отримується з бекенда асинхронно

---

## 🧪 Тестування

### Тестовий файл

У проекті є готовий `test-lootbox.html` для тестування інтеграції:

**Як використовувати:**
1. Запустити dev-сервер: `npm run dev`
2. Відкрити `http://localhost:5173/test-lootbox.html`
3. Налаштувати параметри (тема, сектори, VIP рівень)
4. Натиснути "Запустити" (відправить `startSpin`)
5. Вибрати виграшний сектор (0-7) і натиснути "Застосувати" (відправить `winSector`)
6. Переглянути логи PostMessage комунікації

### Debug режим

**Увімкнути FPS монітор:**
```
?fps=true
```

**Логування всіх повідомлень:**
```javascript
window.addEventListener('message', (event) => {
  console.log('[Lootbox]', event.data.type, event.data);
});
```

---

## 📋 Контрольний список

### Підготовка
- [ ] Визначено URL віджета
- [ ] Створено конфігурацію секторів (`sectors`, `sectors_type`)
- [ ] Налаштовано API endpoint для отримання виграшного сектора
- [ ] Налаштовано API endpoint для нарахування призів

### Реалізація
- [ ] Створено iframe з динамічним URL
- [ ] Реалізовано слухач повідомлень від iframe
- [ ] Обробляється `lootboxReady` → розблокування UI
- [ ] Обробляється `spinEnd` → нарахування призу
- [ ] Реалізовано відправку `startSpin` при кліку користувача
- [ ] Реалізовано запит на бекенд після `startSpin`
- [ ] Реалізовано відправку `winSector` після отримання відповіді бекенда
- [ ] Додано обробку помилок (timeout, network errors)
- [ ] Додано валідацію індексу сектора

### Тестування
- [ ] Перевірено завантаження з різними темами (`RocketWheelLite`, `RocketWheelPro`)
- [ ] Протестовано всі сектори (0 до N-1)
- [ ] Перевірено обробку помилок бекенда
- [ ] Протестовано на різних пристроях (desktop, mobile, tablet)
- [ ] Перевірено responsive дизайн
- [ ] Протестовано з різними VIP рівнями

### Production
- [ ] Налаштовано перевірку `event.origin` для безпеки
- [ ] Додано аналітику (tracking подій)
- [ ] Реалізовано обробку edge cases
- [ ] Проведено навантажувальне тестування

---

## 🆘 Типові проблеми

### Лутбокс не завантажується
- Перевірте URL та query-параметри
- Перевірте CORS налаштування
- Відкрийте консоль браузера для помилок

### Не отримую `lootboxReady`
- Слухач `message` має бути доданий ДО встановлення `iframe.src`
- Перевірте що не фільтруєте повідомлення за `event.origin` надто строго

### Колесо обертається нескінченно
- Не відправлено `winSector` або відправлено з помилкою
- Перевірте що індекс сектора валідний
- Перевірте що `winSector` відправлено після `startSpin`

### Невірний приз у `spinEnd`
- Індекс `winSector` не відповідає масиву `sectors`
- Перевірте порядок елементів у `sectors` та `sectors_type`
- Перевірте що індекс відповідає візуальній нумерації колеса

### Проблеми з mobile
- Перевірте `aspect-ratio` iframe (має бути 1:1)
- Перевірте що iframe має коректну ширину/висоту
- Протестуйте на реальних пристроях

---

## 📞 Додаткові ресурси

- **Тестовий файл:** `test-lootbox.html` - reference implementation
- **Технічна документація:** `DOCUMENTATION.md` - деталі про архітектуру віджета
- **Консоль браузера:** Network tab + Console для діагностики

---

**Версія:** 1.0  
**Дата:** 17 жовтня 2025
