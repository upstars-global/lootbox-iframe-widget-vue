<!doctype html>
<html lang="">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lootbox Widget</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <!-- Preload preloader SVGs for all themes -->
    <link
      rel="preload"
      as="image"
      href="themes/RocketWheelLite/images/preloader.svg"
    />
    <link
      rel="preload"
      as="image"
      href="themes/RocketWheelPro/images/preloader.svg"
    />
    <link
      rel="preload"
      as="image"
      href="themes/KingWheel/images/preloader.svg"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&family=Roboto+Slab:wght@900&family=Rubik:wght@700&display=swap"
      rel="stylesheet"
    />
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      * {
        margin: 0;
        padding: 0;
      }

      html,
      body {
        width: 100%;
        height: 100%;
        overflow: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        background-color: #000a12;
      }

      /* CRITICAL: Protection against the "white square" during hard reload.
         There's a micro-delay between reload start and JS script execution.
         During this time the browser may clear image cache, leaving broken images with a white background.
         These styles act as insurance in case JS doesn't fire in time. */

      img,
      svg,
      canvas {
        background: transparent !important;
      }

      img:not([src]),
      img[src=''],
      img[src='about:blank'] {
        opacity: 0 !important;
        visibility: hidden !important;
      }

      body {
        display: flex;
        align-items: end;
        line-height: 1;
        font-family:
          -apple-system, system-ui, BlinkMacSystemFont, 'Segoe UI', Roboto,
          'Helvetica Neue', Arial, sans-serif;
      }

      #app {
        position: absolute;
        top: 0;
        left: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        width: 100%;
        text-align: center;
        overflow: hidden;
      }

      /* FOUC (Flash Of Unstyled Content) protection:
         If the theme is not ready (no CSS and not all images are loaded), hide the body.
         bootstrap.js sets data-theme-ready="1" — so content appears at once, without flicker.
         If you don't want to hide all content — you can remove this block.
      */
      html:not([data-theme-ready='1']) body {
        visibility: hidden;
      }

      /* CRITICAL: When hiding the body (reload), disable ALL transition/animation
         for INSTANT disappearance of content. Otherwise .center-bg with transition: all 3s
         will disappear for 3 seconds, which looks like a bug. */
      html:not([data-theme-ready='1']) body * {
        transition: none !important;
        animation: none !important;
      }

      .preloader-bg {
        position: absolute;
        width: 100%;
        height: 100%;
        inset: 0;
        z-index: 100;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #000a12;
        transition: opacity 0.5s linear;
      }

      .preloader {
        position: absolute;
        height: 25%;
        width: auto;
        aspect-ratio: 1/1;
      }

      #app.lootbox-inactive {
        opacity: 0.6;
      }

      #app.lootbox-inactive * {
        animation: none !important;
        transition: none !important;
      }

      #app.lootbox-inactive .purple-wave,
      #app.lootbox-inactive .center-flashes {
        display: none;
      }
    </style>
  </head>

  <body>
    <!-- Preloader background (image set dynamically - inline for instant rendering) -->
    <div id="preloader-bg" class="preloader-bg">
      <img class="preloader" id="preloader-img" alt="" />
    </div>
    <div id="app"></div>
    <script>
      ;(function () {
        // 1. SYNCHRONOUS preloader src assignment for instant display
        var params = new URLSearchParams(location.search)
        var style = params.get('style')
        var project = params.get('project')

        // Determine theme for preloader:
        // - If ?style= is provided, use it
        // - If only ?project= is provided, use project default theme
        // - Fallback to RocketWheelLite
        var theme = style
        if (!theme && project) {
          // Project default themes mapping (must match config.ts isProjectDefault: true)
          var projectDefaults = {
            rocket: 'RocketWheelLite',
            king: 'KingWheel',
          }
          theme = projectDefaults[project] || 'RocketWheelLite'
        }
        if (!theme) {
          theme = 'RocketWheelLite'
        }

        document.getElementById('preloader-img').src =
          'themes/' + theme + '/images/preloader.svg'

        // 2. PROTECTION from "white square" during hard reload
        // When the browser begins reload, it clears image cache but DOM elements stay.
        // Remove data-theme-ready="1" attribute → CSS rule automatically hides body.
        function hideContent() {
          document.documentElement.removeAttribute('data-theme-ready')
        }

        // Listen to all possible reload events
        window.addEventListener('beforeunload', hideContent, { capture: true })
        window.addEventListener('pagehide', hideContent, { capture: true })
        window.addEventListener('unload', hideContent, { capture: true })

        // 3. AUTOMATIC hiding of broken images
        document.addEventListener(
          'error',
          function (e) {
            if (e.target && e.target.tagName === 'IMG') {
              e.target.style.display = 'none'
            }
          },
          true
        )
      })()
    </script>

    <!-- early runtime: determine theme, include CSS, wait for ALL images to load -->
    <script src="themes/themes-config.js"></script>
    <script src="js/bootstrap.js"></script>
    <!-- Vue app starts ONLY after theme is ready (see main.ts) -->
    <script type="module" src="src/main.ts"></script>
  </body>
</html>
