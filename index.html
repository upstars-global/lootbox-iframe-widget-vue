<!doctype html>
<html lang="">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lootbox Widget</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <!-- Preload preloader SVGs for all themes -->
    <link
      rel="preload"
      as="image"
      href="themes/RocketWheelLite/images/preloader.svg"
    />
    <link
      rel="preload"
      as="image"
      href="themes/RocketWheelPro/images/preloader.svg"
    />
    <link
      rel="preload"
      as="image"
      href="themes/KingWheel/images/preloader.svg"
    />
    <link
      rel="preload"
      as="image"
      href="themes/ThorWheel/images/preloader.svg"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&family=Roboto+Slab:wght@900&family=Rubik:wght@700&display=swap"
      rel="stylesheet"
    />
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      * {
        margin: 0;
        padding: 0;
      }

      html,
      body {
        width: 100%;
        height: 100%;
        overflow: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        background-color: var(--theme-bg-color, #000a12);
      }

      /* CRITICAL: Protection against the "white square" during hard reload.
         There's a micro-delay between reload start and JS script execution.
         During this time the browser may clear image cache, leaving broken images with a white background.
         These styles act as insurance in case JS doesn't fire in time. */

      img,
      svg,
      canvas {
        background: transparent !important;
      }

      img:not([src]),
      img[src=''],
      img[src='about:blank'] {
        opacity: 0 !important;
        visibility: hidden !important;
      }

      body {
        display: flex;
        align-items: end;
        line-height: 1;
        font-family:
          -apple-system, system-ui, BlinkMacSystemFont, 'Segoe UI', Roboto,
          'Helvetica Neue', Arial, sans-serif;
      }

      #app {
        position: absolute;
        top: 0;
        left: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        width: 100%;
        text-align: center;
        overflow: hidden;
      }

      /* FOUC (Flash Of Unstyled Content) protection:
         If the theme is not ready (no CSS and not all images are loaded), hide the body.
         bootstrap.js sets data-theme-ready="1" — so content appears at once, without flicker.
         If you don't want to hide all content — you can remove this block.
      */
      html:not([data-theme-ready='1']) body {
        visibility: hidden;
      }

      /* CRITICAL: When hiding the body (reload), disable ALL transition/animation
         for INSTANT disappearance of content. Otherwise .center-bg with transition: all 3s
         will disappear for 3 seconds, which looks like a bug. */
      html:not([data-theme-ready='1']) body * {
        transition: none !important;
        animation: none !important;
      }

      .preloader-bg {
        position: absolute;
        width: 100%;
        height: 100%;
        inset: 0;
        z-index: 100;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: var(--theme-bg-color, #000a12);
        transition: opacity 0.5s linear;
      }

      .preloader {
        position: absolute;
        height: 25%;
        width: auto;
        aspect-ratio: 1/1;
      }

      #app.lootbox-inactive {
        opacity: 0.6;
      }

      #app.lootbox-inactive * {
        animation: none !important;
        transition: none !important;
      }

      #app.lootbox-inactive .purple-wave,
      #app.lootbox-inactive .center-flashes {
        display: none;
      }
    </style>
    <!--
      Synchronous script to set background BEFORE body rendering (prevents FOUC - Flash of Unstyled Content)
      
      Why it's needed:
      - bootstrap.js loads asynchronously and sets theme background from config.ts
      - During async load, body renders with default background causing visible flash
      - This inline script executes synchronously BEFORE body renders, setting correct background immediately
      
      How it works:
      1. Reads URL params: ?style=KingWheel or ?project=king
      2. Determines theme (explicit style > project default > RocketWheelLite)
      3. Sets --theme-bg-color CSS variable from hardcoded mapping
      4. Body renders with correct background from the start
      
      Note: themeBgColors must match backgroundColor values in theme config.ts files
    -->
    <script>
      ;(function () {
        var params = new URLSearchParams(location.search)
        var style = params.get('style')
        var project = params.get('project')
        var theme = style
        if (!theme && project) {
          var projectDefaults = {
            rocket: 'RocketWheelLite',
            king: 'KingWheel',
            thor: 'ThorWheel',
          }
          theme = projectDefaults[project] || 'RocketWheelLite'
        }
        if (!theme) theme = 'RocketWheelLite'
        var themeBgColors = {
          KingWheel: '#F8F7FA',
          RocketWheelLite: '#000a12',
          RocketWheelPro: '#000a12',
          ThorWheel: '#000a12',
        }
        document.documentElement.style.setProperty(
          '--theme-bg-color',
          themeBgColors[theme] || '#000a12'
        )

        // FullStory initialization (only if fs_org parameter is provided)
        var fsOrg = params.get('fs_org')
        if (fsOrg) {
          window['_fs_run_in_iframe'] = true
          window['_fs_debug'] = false
          window['_fs_host'] = 'fullstory.com'
          window['_fs_script'] = 'edge.fullstory.com/s/fs.js'
          window['_fs_org'] = fsOrg
          window['_fs_namespace'] = 'FS'
          ;(function (m, n, e, t, l, o, g, y) {
            if (e in m) {
              if (m.console && m.console.log) {
                m.console.log('FullStory namespace conflict.')
              }
              return
            }
            g = m[e] = function (a, b, s) {
              g.q ? g.q.push([a, b, s]) : g._api(a, b, s)
            }
            g.q = []
            o = n.createElement(t)
            o.async = 1
            o.crossOrigin = 'anonymous'
            o.src = 'https://' + window['_fs_script']
            y = n.getElementsByTagName(t)[0]
            y.parentNode.insertBefore(o, y)
            g.identify = function (i, v, s) {
              g(l, { uid: i }, s)
              if (v) g(l, v, s)
            }
            g.setUserVars = function (v, s) {
              g(l, v, s)
            }
            g.event = function (i, v, s) {
              g('event', { n: i, p: v }, s)
            }
            g.anonymize = function () {
              g.identify(!!0)
            }
            g.shutdown = function () {
              g('rec', !1)
            }
            g.restart = function () {
              g('rec', !0)
            }
            g.log = function (a, b) {
              g('log', [a, b])
            }
            g.consent = function (a) {
              g('consent', !arguments.length || a)
            }
            g.identifyAccount = function (i, v) {
              o = 'account'
              v = v || {}
              v.acctId = i
              g(o, v)
            }
            g.clearUserCookie = function () {}
            g.setVars = function (n, p) {
              g('setVars', [n, p])
            }
            g._w = {}
            y = 'XMLHttpRequest'
            g._w[y] = m[y]
            y = 'fetch'
            g._w[y] = m[y]
            if (m[y])
              m[y] = function () {
                return g._w[y].apply(this, arguments)
              }
            g._v = '1.3.0'
          })(window, document, window['_fs_namespace'], 'script', 'user')
        }
      })()
    </script>
  </head>

  <body>
    <!-- Preloader background (image set dynamically - inline for instant rendering) -->
    <div id="preloader-bg" class="preloader-bg">
      <img class="preloader" id="preloader-img" alt="" />
    </div>
    <div id="app"></div>
    <script>
      ;(function () {
        // 1. SYNCHRONOUS preloader src assignment for instant display
        var params = new URLSearchParams(location.search)
        var style = params.get('style')
        var project = params.get('project')

        // Determine theme for preloader:
        // - If ?style= is provided, use it
        // - If only ?project= is provided, use project default theme
        // - Fallback to RocketWheelLite
        var theme = style
        if (!theme && project) {
          // Project default themes mapping (must match config.ts isProjectDefault: true)
          var projectDefaults = {
            rocket: 'RocketWheelLite',
            king: 'KingWheel',
            thor: 'ThorWheel',
          }
          theme = projectDefaults[project] || 'RocketWheelLite'
        }
        if (!theme) {
          theme = 'RocketWheelLite'
        }

        document.getElementById('preloader-img').src =
          'themes/' + theme + '/images/preloader.svg'

        // 1.1. Set background color based on theme (prevents FOUC)
        var themeBgColors = {
          KingWheel: '#F8F7FA',
          RocketWheelLite: '#000a12',
          RocketWheelPro: '#000a12',
          ThorWheel: '#000a12',
        }
        var bgColor = themeBgColors[theme] || '#000a12'
        document.documentElement.style.setProperty('--theme-bg-color', bgColor)

        // 2. PROTECTION from "white square" during hard reload
        // When the browser begins reload, it clears image cache but DOM elements stay.
        // Remove data-theme-ready="1" attribute → CSS rule automatically hides body.
        function hideContent() {
          document.documentElement.removeAttribute('data-theme-ready')
        }

        // Listen to all possible reload events
        window.addEventListener('beforeunload', hideContent, { capture: true })
        window.addEventListener('pagehide', hideContent, { capture: true })
        window.addEventListener('unload', hideContent, { capture: true })

        // 3. AUTOMATIC hiding of broken images
        document.addEventListener(
          'error',
          function (e) {
            if (e.target && e.target.tagName === 'IMG') {
              e.target.style.display = 'none'
            }
          },
          true
        )
      })()
    </script>

    <!-- early runtime: determine theme, include CSS, wait for ALL images to load -->
    <script src="themes/themes-config.js"></script>
    <script src="js/bootstrap.js"></script>
    <!-- Vue app starts ONLY after theme is ready (see main.ts) -->
    <script type="module" src="src/main.ts"></script>
  </body>
</html>
