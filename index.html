<!doctype html>
<html lang="">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lootbox Widget</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <!-- Preload preloader SVGs for both themes -->
    <link
      rel="preload"
      as="image"
      href="themes/RocketWheelLite/images/preloader.svg"
    />
    <link
      rel="preload"
      as="image"
      href="themes/RocketWheelPro/images/preloader.svg"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@900&family=Rubik:wght@700&display=swap"
      rel="stylesheet"
    />
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      * {
        margin: 0;
        padding: 0;
      }

      html,
      body {
        width: 100%;
        height: 100%;
        overflow: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        background-color: #000a12;
      }

      /* КРИТИЧНО: Захист від "білого квадрата" під час hard reload.
         Є мікрозатримка між початком reload і спрацюванням JS скрипта.
         У цей момент браузер може очистити кеш зображень, залишивши broken images з білим фоном.
         Ці стили страхують на випадок, якщо JS не встигне спрацювати. */

      img,
      svg,
      canvas {
        background: transparent !important;
      }

      img:not([src]),
      img[src=''],
      img[src='about:blank'] {
        opacity: 0 !important;
        visibility: hidden !important;
      }

      body {
        display: flex;
        align-items: end;
        line-height: 1;
        font-family:
          -apple-system, system-ui, BlinkMacSystemFont, 'Segoe UI', Roboto,
          'Helvetica Neue', Arial, sans-serif;
      }

      #app {
        position: absolute;
        top: 0;
        left: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        width: 100%;
        text-align: center;
        overflow: hidden;
      }

      /* Страховка від FOUC (Flash Of Unstyled Content):
         Поки тема не готова (немає CSS і не підвантажені всі зображення), ховаємо body.
         bootstrap.js виставить data-theme-ready="1" — і контент з'явиться одномоментно, без мерехтіння.
         Якщо не хочеться ховати весь контент — можна прибрати цей блок.
      */
      html:not([data-theme-ready='1']) body {
        visibility: hidden;
      }

      /* КРИТИЧНО: При скритті body (reload) відключаємо ВСІ transition/animation
         для МИТТЄВОГО зникнення контенту. Інакше .center-bg з transition: all 3s 
         буде зникати 3 секунди, що виглядає як баг. */
      html:not([data-theme-ready='1']) body * {
        transition: none !important;
        animation: none !important;
      }

      .preloader-bg {
        position: absolute;
        width: 100%;
        height: 100%;
        inset: 0;
        z-index: 100;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #000a12;
        transition: opacity 0.5s linear;
      }

      .preloader {
        position: absolute;
        height: 25%;
        width: auto;
        aspect-ratio: 1/1;
      }

      #app.lootbox-inactive {
        opacity: 0.6;
      }

      #app.lootbox-inactive * {
        animation: none !important;
        transition: none !important;
      }

      #app.lootbox-inactive .purple-wave,
      #app.lootbox-inactive .center-flashes {
        display: none;
      }
    </style>
  </head>

  <body>
    <!-- фон-прелоадер (картинку поставимо динамічно - інлайн для миттєвого рендеру) -->
    <div id="preloader-bg" class="preloader-bg">
      <img class="preloader" id="preloader-img" alt="" />
    </div>
    <div id="app"></div>
    <script>
      ;(function () {
        // 1. СИНХРОННА установка preloader src для миттєвого відображення
        var params = new URLSearchParams(location.search)
        var theme = params.get('style') || 'RocketWheelLite'
        document.getElementById('preloader-img').src =
          'themes/' + theme + '/images/preloader.svg'

        // 2. ЗАХИСТ від "білого квадрата" під час hard reload
        // Коли браузер починає reload, він очищає кеш зображень, але елементи залишаються в DOM.
        // Прибираємо атрибут data-theme-ready="1" → CSS правило автоматично ховає body.
        function hideContent() {
          document.documentElement.removeAttribute('data-theme-ready')
        }

        // Відслідковуємо всі можливі події reload
        window.addEventListener('beforeunload', hideContent, { capture: true })
        window.addEventListener('pagehide', hideContent, { capture: true })
        window.addEventListener('unload', hideContent, { capture: true })

        // Для деяких браузерів також відслідковуємо visibilitychange
        document.addEventListener('visibilitychange', function () {
          if (document.visibilityState === 'hidden') {
            hideContent()
          }
        })

        // 3. АВТОМАТИЧНЕ скриття зламаних зображень
        document.addEventListener(
          'error',
          function (e) {
            if (e.target && e.target.tagName === 'IMG') {
              e.target.style.display = 'none'
            }
          },
          true
        )
      })()
    </script>

    <!-- ранній рантайм: визначаємо тему, підключаємо CSS і чекаємо ВСІ картинки -->
    <script src="themes/themes-config.js"></script>
    <script src="js/bootstrap.js"></script>
    <!-- Vue-додаток стартує ТІЛЬКИ після готовності теми (див. main.ts) -->
    <script type="module" src="src/main.ts"></script>
  </body>
</html>
