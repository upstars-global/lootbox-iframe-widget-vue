<!doctype html>
<html lang="uk">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üé∞ Lootbox Widget</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
    }

    .controls {
      background: white;
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      height: fit-content;
    }

    .widget-section {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 24px;
      display: flex;
      flex-direction: column;
    }

    .widget-controls {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 16px;
    }

    .widget-controls .control-group {
      margin-bottom: 0;
    }

    .widget-controls .action-buttons {
      margin: 0;
    }

    .control-group {
      margin-bottom: 16px;
    }

    .control-group:last-child {
      margin-bottom: 0;
    }

    .control-group label,
    .control-group .label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }

    .control-group.checkbox .label-container {
      display: flex;
      align-items: start;
      gap: 8px;
    }

    .control-group.checkbox .label-container input {
      width: auto;
    }

    .theme-select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }

    #winningSector {
      width: auto;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }

    h2,
    h3 {
      font-size: 1.5em;
      margin: 0 0 24px 0;
      color: #333;
    }

    .control-group input:not(.theme-input),
    .control-group select,
    .control-group textarea,
    .control-group .contenteditable-textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }

    .control-group textarea {
      resize: vertical;
      background: white;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      border: 1px solid #e9ecef;
      box-sizing: border-box;
    }

    .control-group .contenteditable-textarea {
      resize: vertical;
      background: white;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      border: 1px solid #e9ecef;
      box-sizing: border-box;
      overflow-y: auto;
      word-break: break-all;
      outline: none;
    }

    .control-group .contenteditable-textarea:focus {
      border-color: #007bff;
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }

    .control-group .contenteditable-textarea[data-placeholder]:empty:before {
      content: attr(data-placeholder);
      color: #6c757d;
      font-style: italic;
    }

    .control-group .contenteditable-textarea.spinning {
      background: #f5f5f5;
      color: #999;
      cursor: not-allowed;
    }

    .control-group textarea.spinning {
      background: #f5f5f5;
      color: #999;
      cursor: not-allowed;
    }

    .theme-select.spinning {
      background: #f5f5f5;
      color: #999;
      cursor: not-allowed;
    }

    .label-container {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: bold;
      color: #333;
    }

    .copy-btn {
      background: none;
      color: #007bff;
      border: none;
      cursor: pointer;
      font-size: 16px;
      transition: color 0.2s;
      padding: 2px;
      border-radius: 3px;
    }

    .copy-btn:hover {
      color: #0056b3;
      background: #f8f9fa;
    }

    .copy-btn:active {
      color: #004085;
    }

    .iframe-wrapper {
      width: 100%;
      height: 100%;
      /* min-height: 470px;
        height: 400px; */
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      background: #000;
      resize: both;
      overflow: auto;
    }

    iframe {
      width: 100%;
      height: 100%;
      /* min-height: 470px; */
      border: none;
      border-radius: 8px;
    }

    .log-section {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 24px;
      display: flex;
      flex-direction: column;
    }

    .log {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 15px;
      flex: 1;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }

    .log-entry {
      margin: 8px 0;
      padding: 8px;
      border-radius: 3px;
      border-left: 3px solid transparent;
      font-weight: 500;
    }

    .log-received {
      background: #d4edda;
      color: #155724;
      border-left-color: #28a745;
    }

    .log-sent {
      background: #cce5ff;
      color: #004085;
      border-left-color: #007bff;
    }

    .log-error {
      background: #f8d7da;
      color: #721c24;
      border-left-color: #dc3545;
    }

    .log-info {
      background: #d1ecf1;
      color: #0c5460;
      border-left-color: #17a2b8;
    }

    .action-buttons {
      display: flex;
      gap: 12px;
      margin: 0 0 16px 0;
      flex-wrap: wrap;
    }

    .btn {
      min-width: 120px;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s;
    }

    .btn-primary {
      background: #007bff;
      color: white;
    }

    .btn-primary:hover {
      background: #0056b3;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #545b62;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #1e7e34;
    }

    .btn:disabled {
      opacity: 0.8;
      cursor: not-allowed;
      pointer-events: none;
    }

    .winning-sector-control {
      margin-bottom: 16px;
    }

    .winning-sector-control label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }

    .winning-sector-control select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }

    .apply-custom-url-btn {
      margin-top: 16px;
    }

    .status {
      padding: 12px;
      border-radius: 4px;
      margin: 0 0 16px 0;
      font-size: 14px;
    }

    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    @media (max-width: 1024px) {
      .container {
        gap: 15px;
      }

      .controls,
      .widget-section,
      .log-section {
        padding: 15px;
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 12px;
      }

      .container {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .controls,
      .widget-section {
        padding: 16px;
      }

      .control-group {
        margin-bottom: 12px;
      }

      .control-group label {
        margin-bottom: 6px;
      }

      h2,
      h3 {
        margin: 0 0 16px 0;
      }

      .action-buttons {
        gap: 8px;
        margin: 12px 0;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="controls">
      <div class="status info">
        <strong>–Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è:</strong><br />
        - –û–±—Ä–∞—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ <br />
        - –ù–∞—Ç–∏—Å–Ω—É—Ç–∏ "–ó–∞–ø—É—Å—Ç–∏—Ç–∏" <br />
        - –í–∏–±—Ä–∞—Ç–∏ winSector <br />
        - –ù–∞—Ç–∏—Å–Ω—É—Ç–∏ "–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏" <br />
      </div>

      <div class="control-group">
        <label for="themeSelect">–¢–µ–º–∞:</label>
        <select id="themeSelect" class="theme-select">
          <option value="RocketWheelLite">RocketWheelLite (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º)</option>
          <option value="RocketWheelPro">RocketWheelPro</option>
        </select>
      </div>

      <div class="control-group">
        <div class="contenteditable-textarea" id="sectors" contenteditable="true"
          data-placeholder="500 USD, 5000 USD, 10 FS, 20 FS, 35 FS, 25 USD, 100 USD, 250 USD"></div>
      </div>

      <div class="control-group">
        <div class="contenteditable-textarea" id="sectorsType" contenteditable="true"
          data-placeholder="Bonus Prize, Bonus Prize, Free Spins, Free Spins, Free Spins, Bonus Prize, Bonus Prize, Bonus Prize">
        </div>
      </div>

      <div class="control-group checkbox">
        <label class="label-container">
          <input type="checkbox" id="activeCheckbox" checked style="display: inline-block" />
          active
        </label>
      </div>

      <div class="control-group checkbox">
        <label class="label-container">
          <input type="checkbox" id="fpsCheckbox" style="display: inline-block" />
          fps
        </label>
      </div>

      <div class="control-group">
        <div class="label">
          URL (example)
          <button class="copy-btn" onclick="copyWidgetUrl()" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å URL">
            üìÑ
          </button>
        </div>
        <div class="contenteditable-textarea" id="widgetUrl"></div>
      </div>

      <div class="control-group">
        <div class="label">URL (custom)</div>
        <div class="contenteditable-textarea" id="customUrl" contenteditable="true"
          data-placeholder="–í–≤–µ–¥—ñ—Ç—å URL http://localhost:5173/?style=1&..."></div>
        <button class="btn btn-primary apply-custom-url-btn" onclick="applyCustomUrl()">
          –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ URL
        </button>
      </div>
    </div>

    <div class="widget-section">
      <div class="widget-controls">
        <div class="action-buttons">
          <button class="btn btn-success" id="startSpinBtn" onclick="startSpin()">
            –ó–∞–ø—É—Å—Ç–∏—Ç–∏
          </button>
        </div>

        <div class="control-group" style="display: flex; gap: 10px; align-items: center">
          <div class="label-container">
            winSector:
            <select id="winningSector">
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
            </select>
          </div>
          <button class="btn btn-primary" id="setWinningSectorBtn" onclick="setWinningSector()">
            –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏
          </button>
        </div>
      </div>

      <div class="iframe-wrapper">
        <iframe id="widgetFrame" src=""></iframe>
      </div>
    </div>

    <div class="log-section">
      <div class="control-group">
        <div class="label-container">
          Post messages
          <button class="btn btn-secondary" onclick="clearLog()">
            –û—á–∏—Å—Ç–∏—Ç–∏
          </button>
        </div>
      </div>
      <div class="log" id="messageLog"></div>
    </div>
  </div>

  <script>
    // –ü–æ—á–∞—Ç–∫–æ–≤—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏
    let currentParams = {
      style: 'RocketWheelLite',
      sectors:
        '500 USD, 5000 USD, 10 FS, 20 FS, 35 FS, 25 USD, 100 USD, 250 USD',
      sectors_type:
        'Bonus Prize, Bonus Prize, Free Spins, Free Spins, Free Spins, Bonus Prize, Bonus Prize, Bonus Prize',
      active: true,
      fps: false,
    }

    let widgetReady = false
    let isSpinning = false
    let winningSectorSet = false
    let iframe = document.getElementById('widgetFrame')
    const messageLog = document.getElementById('messageLog')
    const startSpinBtn = document.getElementById('startSpinBtn')
    const setWinningSectorBtn = document.getElementById('setWinningSectorBtn')

    function disableStartButton() {
      startSpinBtn.disabled = true
      isSpinning = true
      updateButtonsState()
    }

    function disableSectorButton() {
      setWinningSectorBtn.disabled = true
      winningSectorSet = true
    }

    function enableButtons() {
      startSpinBtn.disabled = false
      setWinningSectorBtn.disabled = false
      isSpinning = false
      winningSectorSet = false
      updateButtonsState()
    }

    function initializeContentEditable() {
      const contentEditableElements = document.querySelectorAll(
        '.contenteditable-textarea'
      )

      contentEditableElements.forEach(element => {
        if (element.id === 'sectors') {
          element.textContent =
            '500 USD, 5000 USD, 10 FS, 20 FS, 35 FS, 25 USD, 100 USD, 250 USD'
        } else if (element.id === 'sectorsType') {
          element.textContent =
            'Bonus Prize, Bonus Prize, Free Spins, Free Spins, Free Spins, Bonus Prize, Bonus Prize, Bonus Prize'
        }

        element.addEventListener('paste', e => {
          e.preventDefault()
          const text = e.clipboardData.getData('text/plain')
          document.execCommand('insertText', false, text)
        })
      })
    }

    function updateButtonsState() {
      const isActive = currentParams.active
      const winningSectorSelect = document.getElementById('winningSector')
      const themeSelect = document.getElementById('themeSelect')
      const sectorsInput = document.getElementById('sectors')
      const sectorsTypeInput = document.getElementById('sectorsType')
      const customUrlInput = document.getElementById('customUrl')
      const activeCheckbox = document.getElementById('activeCheckbox')
      const fpsCheckbox = document.getElementById('fpsCheckbox')
      const clearLogBtn = document.querySelector(
        'button[onclick="clearLog()"]'
      )
      const applyCustomUrlBtn = document.querySelector(
        'button[onclick="applyCustomUrl()"]'
      )
      const widgetUrlElement = document.getElementById('widgetUrl')

      const isBlocked = isSpinning || !isActive

      startSpinBtn.disabled = !isActive || isSpinning
      setWinningSectorBtn.disabled =
        !isActive || !isSpinning || winningSectorSet
      winningSectorSelect.disabled =
        !isActive || !isSpinning || winningSectorSet
      themeSelect.disabled = isBlocked
      sectorsInput.contentEditable = !isBlocked
      sectorsTypeInput.contentEditable = !isBlocked
      if (customUrlInput) customUrlInput.contentEditable = !isBlocked
      activeCheckbox.disabled = isSpinning
      if (fpsCheckbox) fpsCheckbox.disabled = isSpinning

      if (sectorsInput) {
        sectorsInput.classList.toggle('spinning', isSpinning)
      }
      if (sectorsTypeInput) {
        sectorsTypeInput.classList.toggle('spinning', isSpinning)
      }
      if (customUrlInput) {
        customUrlInput.classList.toggle('spinning', isSpinning)
      }

      if (widgetUrlElement) {
        widgetUrlElement.classList.toggle('spinning', isSpinning)
      }

      if (themeSelect) {
        themeSelect.classList.toggle('spinning', isSpinning)
      }

      if (clearLogBtn) clearLogBtn.disabled = isSpinning || !isActive
      if (applyCustomUrlBtn) applyCustomUrlBtn.disabled = isSpinning
    }

    function setTheme(themeIndex) {
      currentParams.style = themeIndex
      updateWidget()
    }

    function applyCustomUrl() {
      const textarea = document.getElementById('customUrl')
      let customUrl = textarea ? textarea.textContent.trim() : ''

      if (customUrl) {
        customUrl = customUrl.replace(/¬ß/g, '&')

        const url = new URL(customUrl)

        currentParams.style = url.searchParams.get('style') || 'RocketWheelLite'
        currentParams.sectors = url.searchParams.get('sectors') || ''
        currentParams.sectors_type =
          url.searchParams.get('sectors_type') || ''
        currentParams.active = url.searchParams.get('active') !== 'false'
        currentParams.fps = url.searchParams.get('fps') === 'true'

        if (currentParams.sectors) {
          currentParams.sectors = currentParams.sectors.replace(/,/g, ', ')
        }
        if (currentParams.sectors_type) {
          currentParams.sectors_type = currentParams.sectors_type.replace(
            /,/g,
            ', '
          )
        }

        updateFormFields()

        const themeSelect = document.getElementById('themeSelect')
        if (themeSelect) {
          themeSelect.value = currentParams.style
        }

        widgetReady = false

        updateWidget()
      }
    }

    function updateFormFields() {
      const sectorsElement = document.getElementById('sectors')
      const sectorsTypeElement = document.getElementById('sectorsType')
      const activeCheckbox = document.getElementById('activeCheckbox')
      const fpsCheckbox = document.getElementById('fpsCheckbox')

      if (sectorsElement) {
        sectorsElement.textContent = currentParams.sectors
      }
      if (sectorsTypeElement) {
        sectorsTypeElement.textContent = currentParams.sectors_type
      }
      if (activeCheckbox) {
        activeCheckbox.checked = currentParams.active
      }
      if (fpsCheckbox) {
        fpsCheckbox.checked = currentParams.fps
      }
    }

    function updateWidget() {
      const url = new URL('http://localhost:5173/')

      // –î–æ–¥–∞—î–º–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏
      Object.entries(currentParams).forEach(([key, value]) => {
        if (value !== undefined && value !== null && value !== '') {
          url.searchParams.set(key, value)
        }
      })

      const finalUrl = url.toString()

      // –û–Ω–æ–≤–ª—é—î–º–æ URL —Ç–∞ iframe
      document.getElementById('widgetUrl').textContent = finalUrl
      iframe.src = finalUrl
    }

    function updateParams() {
      const sectorsElement = document.getElementById('sectors')
      const sectorsTypeElement = document.getElementById('sectorsType')
      const activeCheckbox = document.getElementById('activeCheckbox')
      const fpsCheckbox = document.getElementById('fpsCheckbox')

      currentParams.sectors = sectorsElement ? sectorsElement.textContent : ''
      currentParams.sectors_type = sectorsTypeElement
        ? sectorsTypeElement.textContent
        : ''
      currentParams.active = activeCheckbox ? activeCheckbox.checked : true
      currentParams.fps = fpsCheckbox ? fpsCheckbox.checked : false

      updateWidget()
    }

    // –°–ª—É—Ö–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ –≤–∏–¥–∂–µ—Ç–∞
    window.addEventListener('message', event => {
      if (!event.data || typeof event.data !== 'object') return

      switch (event.data.type) {
        case 'lootboxReady':
          widgetReady = true
          logMessage('üì§ lootboxReady', 'received', 'WIDGET')
          updateButtonsState()
          break

        case 'spinEnd':
          logMessage(
            `üì§ spinEnd: ${event.data.data.prize}`,
            'received',
            'WIDGET'
          )
          enableButtons()
          updateButtonsState()
          break
      }
    })

    function startSpin() {
      if (isSpinning) {
        return
      }

      disableStartButton()
      const message = { type: 'startSpin' }
      iframe.contentWindow.postMessage(message, '*')
      logMessage('üì• startSpin', 'sent', 'PARENT')
    }

    function setWinningSector() {
      const select = document.getElementById('winningSector')
      const selectedValue = select.value

      const winningSector = parseInt(selectedValue)
      const sectors = currentParams.sectors.split(', ')
      const sectorName =
        sectors[winningSector] || `–°–µ–∫—Ç–æ—Ä ${winningSector + 1}`

      const message = {
        type: 'winSector',
        data: winningSector,
      }

      iframe.contentWindow.postMessage(message, '*')
      logMessage(`üì• winSector: ${winningSector}`, 'sent', 'PARENT')

      winningSectorSet = true
      setWinningSectorBtn.disabled = true
      updateButtonsState()
    }

    function logMessage(message, type = 'info', sender = '') {
      const entry = document.createElement('div')
      entry.className = `log-entry log-${type}`
      const senderPrefix = sender ? `[${sender}] ` : ''
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${senderPrefix}${message}`
      messageLog.appendChild(entry)
      messageLog.scrollTop = messageLog.scrollHeight
    }

    function copyWidgetUrl() {
      const urlDisplay = document.getElementById('widgetUrl')
      const customUrlField = document.getElementById('customUrl')
      const url = urlDisplay.textContent.trim()

      navigator.clipboard.writeText(url).then(() => {
        customUrlField.textContent = url
      })
    }

    function clearLog() {
      messageLog.innerHTML = ''
    }

    document.getElementById('sectors').addEventListener('input', updateParams)
    document
      .getElementById('sectorsType')
      .addEventListener('input', updateParams)
    document
      .getElementById('activeCheckbox')
      .addEventListener('change', updateParams)
    document
      .getElementById('fpsCheckbox')
      .addEventListener('change', updateParams)
    document
      .getElementById('themeSelect')
      .addEventListener('change', function () {
        if (!this.disabled) {
          setTheme(this.value)
        }
      })

    updateWidget()
    updateButtonsState()
    initializeContentEditable()
  </script>
</body>

</html>